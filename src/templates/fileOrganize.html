<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>错误码-整理文件</title>
  <style>
    body {
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-foreground);
      background: var(--vscode-editor-background);
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    /* 标题样式 */
    h2 {
      color: var(--vscode-editor-foreground);
      border-bottom: 2px solid var(--vscode-focusBorder);
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .file-info {
      margin: 20px 0;
      padding: 15px;
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      line-height: 1.6;
    }

    .loading {
      display: flex;
      align-items: center;
      color: var(--vscode-descriptionForeground);
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--vscode-panel-border);
      border-top: 2px solid var(--vscode-focusBorder);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .section {
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .button-group {
      display: flex;
      gap: 16px;
    }

    .button-group>div {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .button-group .btn {
      width: 100%;
      margin: 0;
    }

    .button-group .secondary-buttons {
      display: flex;
      gap: 8px;
    }

    .button-group .secondary-buttons .btn {
      flex: 1;
      font-size: 12px;
      padding: 6px 12px;
    }

    /* Source info: 3-column brief stats */
    .source-brief-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .brief-item {
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 16px;
      text-align: center;
    }

    .brief-label {
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
      font-size: 13px;
    }

    .brief-value {
      font-weight: bold;
      font-size: 18px;
      color: var(--vscode-editor-foreground);
    }

    /* 备份文件选择器样式 */
    .backup-selector {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
    }

    .backup-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .backup-dialog {
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 80%;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .backup-header {
      padding: 16px;
      border-bottom: 1px solid var(--vscode-panel-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .backup-header h3 {
      margin: 0;
      color: var(--vscode-editor-foreground);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--vscode-editor-foreground);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .close-btn:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .backup-list {
      max-height: 400px;
      overflow-y: auto;
      padding: 8px;
    }

    .backup-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin: 4px 0;
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
    }

    .backup-item:hover {
      background: var(--vscode-editor-background);
    }

    .backup-info {
      flex: 1;
    }

    .backup-name {
      font-weight: bold;
      color: var(--vscode-editor-foreground);
      margin-bottom: 4px;
    }

    .backup-time {
      color: var(--vscode-descriptionForeground);
      font-size: 12px;
    }

    .backup-actions {
      display: flex;
      gap: 8px;
    }

    .backup-footer {
      padding: 16px;
      border-top: 1px solid var(--vscode-panel-border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* 确认对话框样式 */
    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1001;
    }

    .confirm-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .confirm-content {
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .confirm-header {
      padding: 16px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .confirm-header h3 {
      margin: 0;
      color: var(--vscode-editor-foreground);
    }

    .confirm-body {
      padding: 16px;
      color: var(--vscode-editor-foreground);
    }

    .confirm-footer {
      padding: 16px;
      border-top: 1px solid var(--vscode-panel-border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }

    .btn:hover {
      background: var(--vscode-button-hoverBackground);
    }

    .btn.secondary {
      background: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }

    .btn.secondary:hover {
      background: var(--vscode-button-secondaryHoverBackground);
    }

    .btn.danger {
      background: #f85149;
      color: #ffffff;
      border-color: #f85149;
    }

    .btn.danger:hover {
      background: #d1242f;
      border-color: #d1242f;
    }

    .organize-results {
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--vscode-panel-border);
      display: none;
    }

    .section-header {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .organize-results h3 {
      margin: 0;
      color: var(--vscode-focusBorder);
    }

    .result-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item .status {
      margin-right: 8px;
      font-size: 16px;
    }

    .result-item .status.success {
      color: #28a745;
    }

    .result-item .status.error {
      color: var(--vscode-errorForeground);
    }

    .result-item .file-name {
      font-weight: bold;
      margin-right: 8px;
      color: var(--vscode-foreground);
    }

    .result-item .message {
      color: var(--vscode-descriptionForeground);
      flex: 1;
    }

    .error-result {
      color: var(--vscode-errorForeground);
      background: var(--vscode-inputValidation-errorBackground);
      border: 1px solid var(--vscode-inputValidation-errorBorder);
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
    }

    .success-result {
      color: #28a745;
      background: var(--vscode-inputValidation-infoBackground);
      border: 1px solid var(--vscode-inputValidation-infoBorder);
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
    }

    .source-info {
      background: var(--vscode-panel-background);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--vscode-panel-border);
    }

    .source-info h3 {
      margin: 0 0 10px 0;
      color: var(--vscode-focusBorder);
    }

    .source-info .info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .source-info .info-item {
      display: flex;
      flex-direction: column;
    }

    .source-info .info-label {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 4px;
    }

    .source-info .info-value {
      font-weight: bold;
      color: var(--vscode-foreground);
    }

    .result-card {
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--vscode-panel-border);
      padding-bottom: 12px;
    }

    .file-name {
      font-weight: bold;
      color: var(--vscode-textLink-foreground);
      font-size: 16px;
    }

    .status {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }

    .status.success {
      background: var(--vscode-notificationsInfoIcon-foreground);
    }

    .status.error {
      background: var(--vscode-notificationsErrorIcon-foreground);
      color: #fff;
    }

    .result-stats {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-item {
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--vscode-textLink-foreground);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .stat-item.missing {
      border-color: var(--vscode-notificationsErrorIcon-foreground);
    }

    .stat-item.missing .stat-value {
      color: var(--vscode-notificationsErrorIcon-foreground);
    }

    .stat-item.redundant {
      border-color: var(--vscode-notificationsWarningIcon-foreground);
    }

    .stat-item.redundant .stat-value {
      color: var(--vscode-notificationsWarningIcon-foreground);
    }

    /* 键详情样式 */
    .key-details {
      margin-top: 12px;
      padding: 12px;
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
    }

    .key-details-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--vscode-textLink-foreground);
    }

    .key-details-content {
      font-family: monospace;
      background: var(--vscode-textBlockQuote-background);
      padding: 8px;
      border-radius: 4px;
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 12px;
      line-height: 1.4;
      max-height: 300px;
      overflow-y: auto;
      overflow-x: hidden;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>错误码 - 整理文件</h2>

    <div class="file-info" id="fileInfo">
      <div class="loading">
        <div class="spinner"></div>
        正在加载文件信息...
      </div>
    </div>

    <!-- <div class="action-buttons">
      <button id="organizeSourceBtn" onclick="organizeSourceFile()">整理源文件</button>
      <button id="organizeTargetBtn" onclick="organizeTargetFiles()">整理目标文件</button>
    </div> -->
    <div class="section">
      <div class="button-group">
        <div>
          <button id="organizeSourceBtn" class="btn" onclick="organizeSourceFile()">整理源文件</button>
          <div class="secondary-buttons">
            <button id="backupSourceBtn" class="btn secondary">备份</button>
            <button id="restoreSourceBtn" class="btn secondary">还原</button>
            <button id="cleanBackupSourceBtn" class="btn secondary">清理</button>
          </div>
        </div>
        <div>
          <button id="organizeTargetBtn" class="btn" onclick="organizeTargetFiles()">整理目标文件</button>
          <div class="secondary-buttons">
            <button id="backupTargetBtn" class="btn secondary">备份</button>
            <button id="restoreTargetBtn" class="btn secondary">还原</button>
            <button id="cleanBackupTargetBtn" class="btn secondary">清理</button>
          </div>
        </div>
      </div>
    </div>

    <div id="sourceInfoSection" class="section">
      <strong style="display: block; margin-bottom: 10px;">源文件信息：</strong>
      <div id="sourceInfoContent">
        <div style="text-align: center; padding: 20px; color: var(--vscode-descriptionForeground);">
          <div class="spinner"></div>
          正在加载源文件信息...
        </div>
      </div>
    </div>

    <div id="resultsSection" class="section" style="display: none;">
      <strong style="display: block; margin-bottom: 10px;" id="resultsTitle">操作结果：</strong>
      <div id="resultsList"></div>
    </div>

    <div id="loadingSection" class="loading" style="display: none;">正在分析文件结构，请稍候...</div>
    <div id="errorSection" class="error" style="display: none;"></div>

    <!-- 备份文件选择器 -->
    <div id="backupSelector" class="backup-selector" style="display: none;">
      <div class="backup-overlay">
        <div class="backup-dialog">
          <div class="backup-header">
            <h3 id="backupSelectorTitle">选择要还原的备份文件</h3>
            <button class="close-btn" onclick="hideBackupSelector()">×</button>
          </div>
          <div class="backup-list" id="backupList">
            <!-- 备份文件列表将在这里动态生成 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 清理备份文件选择器 -->
    <div id="cleanBackupSelector" class="backup-selector" style="display: none;">
      <div class="backup-overlay">
        <div class="backup-dialog">
          <div class="backup-header">
            <h3 id="cleanBackupSelectorTitle">选择要清理的备份文件</h3>
            <button class="close-btn" onclick="hideCleanBackupSelector()">×</button>
          </div>
          <div class="backup-list" id="cleanBackupList">
            <!-- 备份文件列表将在这里动态生成 -->
          </div>
          <div class="backup-footer" id="delFooter">
            <button class="btn danger" onclick="cleanAllBackups()">一键删除全部</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 确认删除对话框 -->
    <div id="confirmDialog" class="confirm-dialog" style="display: none;">
      <div class="confirm-overlay">
        <div class="confirm-content">
          <div class="confirm-header">
            <h3 id="confirmTitle">确认删除</h3>
          </div>
          <div class="confirm-body" id="confirmMessage">
            <!-- 确认消息将在这里动态生成 -->
          </div>
          <div class="confirm-footer">
            <button class="btn secondary" onclick="hideConfirmDialog()">取消</button>
            <button class="btn danger" id="confirmDeleteBtn">确认删除</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();

    // 页面加载时获取文件信息
    window.addEventListener('load', () => {
      loadFileInfo();
      setupBackupButtons();
    });

    // 创建结果卡片头部HTML
    function createResultCardHeader(fileName, status, statusClass = 'success') {
      return `
        <div class="result-card">
          <div class="result-header">
            <div class="file-name">${fileName}</div>
            <div class="status ${statusClass}">${status}</div>
          </div>
      `;
    }

    // 创建统计信息HTML
    function createStatsHTML(stats) {
      return `
        <div class="result-stats">
          <div class="stat-item">
            <div class="stat-value">${stats.originalLines}</div>
            <div class="stat-label">原始行数</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${stats.organizedLines}(${stats.organizedLines - stats.originalLines})</div>
            <div class="stat-label">整理后行数</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${stats.originalKeys}</div>
            <div class="stat-label">原始键数</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${stats.organizedKeys}</div>
            <div class="stat-label">整理后键数</div>
          </div>
          <div class="stat-item missing">
            <div class="stat-value">${stats.missingKeys || 0}</div>
            <div class="stat-label">缺失键数</div>
          </div>
          <div class="stat-item redundant">
            <div class="stat-value">${stats.redundantKeys || 0}</div>
            <div class="stat-label">多余键数</div>
          </div>
        </div>
        ${stats.missingKeys > 0 ? `
          <div class="key-details">
            <div class="key-details-title">缺失的键：</div>
            <div class="key-details-content">${getMissingKeysList(stats)}</div>
          </div>
        ` : ''}
        ${stats.redundantKeys > 0 ? `
          <div class="key-details">
            <div class="key-details-title">多余的键：</div>
            <div class="key-details-content">${getRedundantKeysList(stats)}</div>
          </div>
        ` : ''}
      `;
    }

    // 显示加载状态并隐藏结果区域
    function showLoading() {
      document.getElementById('loadingSection').style.display = 'block';
      document.getElementById('resultsSection').style.display = 'none';
    }

    // 隐藏加载状态
    function hideLoading() {
      document.getElementById('loadingSection').style.display = 'none';
    }

    // 显示错误信息
    function showError(msg) {
      const el = document.getElementById('errorSection');
      el.textContent = msg;
      el.style.display = 'block';
    }

    // 隐藏错误信息
    function hideError() {
      document.getElementById('errorSection').style.display = 'none';
    }

    // 获取缺失键值对列表
    function getMissingKeysList(stats) {
      if (stats.missingKeys === 0) return '';

      if (stats.missingKeyList && stats.missingKeyList.length > 0) {
        return stats.missingKeyList.map(item => `${item.key}: "${item.value}"`).join('\n');
      }

      return `缺失 ${stats.missingKeys} 个键`;
    }

    // 获取多余键值对列表
    function getRedundantKeysList(stats) {
      if (stats.redundantKeys === 0) return '';

      if (stats.redundantKeyList && stats.redundantKeyList.length > 0) {
        return stats.redundantKeyList.map(item => `${item.key}: "${item.value}"`).join('\n');
      }

      return `多余 ${stats.redundantKeys} 个键`;
    }

    // 加载文件信息
    function loadFileInfo() {
      vscode.postMessage({ command: 'getFileInfo' });
    }

    // 设置备份按钮事件
    function setupBackupButtons() {
      // 源文件备份按钮
      document.getElementById('backupSourceBtn').addEventListener('click', () => {
        vscode.postMessage({ command: 'backupSource' });
      });

      document.getElementById('restoreSourceBtn').addEventListener('click', () => {
        vscode.postMessage({ command: 'getBackupList', type: 'source' });
      });

      document.getElementById('cleanBackupSourceBtn').addEventListener('click', () => {
        vscode.postMessage({ command: 'getCleanBackupList', type: 'source' });
      });

      // 目标文件备份按钮
      document.getElementById('backupTargetBtn').addEventListener('click', () => {
        vscode.postMessage({ command: 'backupTarget' });
      });

      document.getElementById('restoreTargetBtn').addEventListener('click', () => {
        vscode.postMessage({ command: 'getBackupList', type: 'target' });
      });

      document.getElementById('cleanBackupTargetBtn').addEventListener('click', () => {
        vscode.postMessage({ command: 'getCleanBackupList', type: 'target' });
      });
    }

    let currentCleanType = '';

    // 整理源文件
    function organizeSourceFile() {
      const organizeSourceBtn = document.getElementById('organizeSourceBtn');
      organizeSourceBtn.textContent = '整理中...';
      organizeSourceBtn.disabled = true;

      // 显示加载状态并隐藏结果区域
      showLoading();
      hideError();

      vscode.postMessage({ command: 'organizeSourceFile' });
    }

    // 整理目标文件
    function organizeTargetFiles() {
      const organizeTargetBtn = document.getElementById('organizeTargetBtn');
      organizeTargetBtn.textContent = '整理中...';
      organizeTargetBtn.disabled = true;

      // 显示加载状态并隐藏结果区域
      showLoading();
      hideError();

      vscode.postMessage({ command: 'organizeTargetFiles' });
    }

    // 监听扩展消息
    window.addEventListener('message', event => {
      const message = event.data;

      switch (message.command) {
        case 'fileInfoResult':
          handleFileInfoResult(message);
          break;
        case 'organizeResult':
          handleOrganizeResult(message);
          break;
        case 'backupSourceResult':
          handleBackupResult(message, '源文件');
          break;
        case 'backupTargetResult':
          handleBackupResult(message, '目标文件');
          break;
        case 'restoreSourceResult':
          handleRestoreResult(message, '源文件');
          break;
        case 'restoreTargetResult':
          handleRestoreResult(message, '目标文件');
          break;
        case 'cleanBackupSourceResult':
          handleCleanBackupResult(message, '源文件');
          break;
        case 'cleanBackupTargetResult':
          handleCleanBackupResult(message, '目标文件');
          break;
        case 'backupListResult':
          showBackupSelector(message, 'restore');
          break;
        case 'cleanBackupListResult':
          showCleanBackupSelector(message);
          break;
      }
    });

    // 处理文件信息结果
    function handleFileInfoResult(message) {
      const fileInfo = document.getElementById('fileInfo');
      const sourceInfoSection = document.getElementById('sourceInfoSection');

      if (!message.success) {
        fileInfo.style.display = 'block';
        fileInfo.innerHTML = `<div class="error">❌ ${message.message}</div>`;
        return;
      }

      const sourceFile = message.sourceFile || 'zh-CN.js';
      const targetFiles = message.files || [];
      const targetFileNames = targetFiles.map(f => f.name).join(', ');

      // 显示文件信息
      fileInfo.style.display = 'block';
      fileInfo.innerHTML = `源文件: ${sourceFile}, 目标语言文件: ${targetFileNames}`;

      // 显示源文件详细信息
      if (message.sourceInfo) {
        const sourceInfoContent = document.getElementById('sourceInfoContent');
        sourceInfoContent.innerHTML = `
          <div class="source-brief-stats">
            <div class="brief-item">
              <div class="brief-label">源文件</div>
              <div class="brief-value">${message.sourceInfo.name}</div>
            </div>
            <div class="brief-item">
              <div class="brief-label">总行数</div>
              <div class="brief-value">${message.sourceInfo.lines || 0}</div>
            </div>
            <div class="brief-item">
              <div class="brief-label">总键数</div>
              <div class="brief-value">${message.sourceInfo.keys || 0}</div>
            </div>
          </div>
        `;
      }
    }

    // 处理整理结果
    function handleOrganizeResult(message) {
      const resultsList = document.getElementById('resultsList');
      const organizeSourceBtn = document.getElementById('organizeSourceBtn');
      const organizeTargetBtn = document.getElementById('organizeTargetBtn');

      // 隐藏加载状态
      hideLoading();


      // 重置按钮状态
      organizeSourceBtn.textContent = '整理源文件';
      organizeSourceBtn.disabled = false;
      organizeTargetBtn.textContent = '整理目标文件';
      organizeTargetBtn.disabled = false;

      if (!message.success) {
        showError(message.message);
        return;
      }

      if (message.type === 'source') {
        // 源文件整理结果
        resultsList.innerHTML = `
          <div class="result-card">
            <div class="result-header">
              <div class="file-name">${message.file}</div>
              <div class="status success">已整理</div>
            </div>
            <div class="result-stats">
              <div class="stat-item">
                <div class="stat-value">${message.sourceInfo?.originalLines || 0}</div>
                <div class="stat-label">原始行数</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${message.sourceInfo?.organizedLines || 0}(${(message.sourceInfo?.organizedLines || 0) - (message.sourceInfo?.originalLines || 0)})</div>
                <div class="stat-label">整理后行数</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${message.sourceInfo?.originalKeys || 0}</div>
                <div class="stat-label">原始键数</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${message.sourceInfo?.organizedKeys || 0}</div>
                <div class="stat-label">整理后键数</div>
              </div>
              <div class="stat-item missing">
                <div class="stat-value">0</div>
                <div class="stat-label">缺失键数</div>
              </div>
              <div class="stat-item redundant">
                <div class="stat-value">0</div>
                <div class="stat-label">多余键数</div>
              </div>
            </div>
          </div>
        `;

        // 显示结果区域
        document.getElementById('resultsSection').style.display = 'block';
      } else if (message.type === 'target') {
        // 目标文件整理结果
        let html = '';
        message.results.forEach(result => {
          if (result.success) {
            html += createResultCardHeader(result.file, '已整理', 'success') +
              createStatsHTML({
                fileName: result.file,
                originalLines: result.originalLines || 0,
                organizedLines: result.organizedLines || 0,
                originalKeys: result.originalKeys || 0,
                organizedKeys: result.organizedKeys || 0,
                missingKeys: result.missingKeys || 0,
                redundantKeys: result.redundantKeys || 0,
                missingKeyList: result.missingKeyList || [],
                redundantKeyList: result.redundantKeyList || []
              }) + '</div>';
          } else {
            html += `
              <div class="result-card">
                <div class="result-header">
                  <div class="file-name">${result.file}</div>
                  <div class="status error">整理失败</div>
                </div>
                <div style="padding: 10px; color: var(--vscode-notificationsErrorIcon-foreground);">
                  ${result.message || '整理失败'}
                </div>
              </div>
            `;
          }
        });

        resultsList.innerHTML = html;

        // 显示结果区域
        document.getElementById('resultsSection').style.display = 'block';
      }
    }

    // 处理备份结果
    function handleBackupResult(message, type) {
      if (message.success) {
        showResults(`${type}备份成功`, message.message);
      } else {
        showError(`${type}备份失败: ${message.message}`);
      }
    }

    // 处理还原结果
    function handleRestoreResult(message, type) {
      if (message.success) {
        showResults(`${type}还原成功`, message.message);
      } else {
        showError(`${type}还原失败: ${message.message}`);
      }
    }

    // 处理清理备份结果
    function handleCleanBackupResult(message, type) {
      if (message.success) {
        showResults(`${type}备份清理成功`, message.message);
      } else {
        showError(`${type}备份清理失败: ${message.message}`);
      }
    }

    // 显示备份文件选择器
    function showBackupSelector(message, actionType) {
      if (!message.success || !message.backupList || message.backupList.length === 0) {
        showError('没有找到备份文件');
        return;
      }

      const backupSelector = document.getElementById('backupSelector');
      const backupList = document.getElementById('backupList');
      const titleElement = document.getElementById('backupSelectorTitle');

      titleElement.textContent = `选择要${actionType === 'restore' ? '还原' : '清理'}的${message.type === 'source' ? '源文件' : '目标文件'}备份`;

      backupList.innerHTML = '';
      message.backupList.forEach(backup => {
        const backupItem = document.createElement('div');
        backupItem.className = 'backup-item';
        backupItem.innerHTML = `
          <div class="backup-info">
            <div class="backup-name">${backup.displayName}</div>
            <div class="backup-time">${backup.timestamp}</div>
          </div>
          <div class="backup-actions">
            <button class="btn secondary" onclick="restoreFromBackup('${backup.fileName}', '${message.type}')">还原</button>
          </div>
        `;
        backupList.appendChild(backupItem);
      });

      backupSelector.style.display = 'block';
    }

    // 显示清理备份文件选择器
    function showCleanBackupSelector(message) {
      if (!message.success || !message.backupList || message.backupList.length === 0) {
        showError('没有找到备份文件');
        return;
      }

      // 设置当前清理类型，供一键删除全部使用
      currentCleanType = message.type;
      console.log('设置清理类型:', message.type);

      const cleanBackupSelector = document.getElementById('cleanBackupSelector');
      const cleanBackupList = document.getElementById('cleanBackupList');
      const titleElement = document.getElementById('cleanBackupSelectorTitle');

      titleElement.textContent = `选择要清理的${message.type === 'source' ? '源文件' : '目标文件'}备份`;

      cleanBackupList.innerHTML = '';
      message.backupList.forEach(backup => {
        const backupItem = document.createElement('div');
        backupItem.className = 'backup-item';
        backupItem.innerHTML = `
          <div class="backup-info">
            <div class="backup-name">${backup.displayName}</div>
            <div class="backup-time">${backup.timestamp}</div>
          </div>
          <div class="backup-actions">
            <button class="btn danger" onclick="cleanSingleBackup('${backup.fileName}', '${message.type}')">删除</button>
          </div>
        `;
        cleanBackupList.appendChild(backupItem);
      });

      cleanBackupSelector.style.display = 'block';
    }

    // 从备份文件还原
    function restoreFromBackup(backupFile, type) {
      hideBackupSelector();
      vscode.postMessage({
        command: type === 'source' ? 'restoreSource' : 'restoreTarget',
        backupFile: backupFile
      });
    }

    // 清理单个备份文件
    function cleanSingleBackup(backupFile, type) {
      hideCleanBackupSelector();
      vscode.postMessage({
        command: type === 'source' ? 'cleanBackupSource' : 'cleanBackupTarget',
        backupFile: backupFile
      });
    }

    // 清理所有备份文件
    function cleanAllBackups() {
      console.log('一键删除全部 - 当前清理类型:', currentCleanType);

      if (!currentCleanType) {
        showError('错误：无法确定清理类型，请重新打开清理对话框');
        return;
      }

      // 使用自定义确认对话框而不是浏览器的 confirm()
      showConfirmDialog(
        `确定要删除所有${currentCleanType === 'source' ? '源文件' : '目标文件'}备份吗？此操作不可撤销！`,
        () => {
          console.log('用户确认删除，发送命令:', currentCleanType === 'source' ? 'cleanBackupSource' : 'cleanBackupTarget');
          hideConfirmDialog();
          hideCleanBackupSelector();
          vscode.postMessage({
            command: currentCleanType === 'source' ? 'cleanBackupSource' : 'cleanBackupTarget'
          });
        }
      );
    }

    // 隐藏备份文件选择器
    function hideBackupSelector() {
      document.getElementById('backupSelector').style.display = 'none';
    }

    // 隐藏清理备份文件选择器
    function hideCleanBackupSelector() {
      document.getElementById('cleanBackupSelector').style.display = 'none';
    }

    // 显示结果
    function showResults(title, content) {
      const resultsSection = document.getElementById('resultsSection');
      const resultsList = document.getElementById('resultsList');
      const resultsTitle = document.getElementById('resultsTitle');

      resultsTitle.textContent = title;
      resultsList.innerHTML = content;
      resultsSection.style.display = 'block';
    }

    // 显示错误
    function showError(message) {
      const resultsSection = document.getElementById('resultsSection');
      const resultsList = document.getElementById('resultsList');
      const resultsTitle = document.getElementById('resultsTitle');

      resultsTitle.textContent = '操作失败';
      resultsList.innerHTML = `<div class="error-result">❌ ${message}</div>`;
      resultsSection.style.display = 'block';
    }

    // 显示确认对话框
    function showConfirmDialog(message, onConfirm) {
      const messageElement = document.getElementById('confirmMessage');
      const confirmBtn = document.getElementById('confirmDeleteBtn');

      messageElement.textContent = message;

      // 移除之前的事件监听器
      confirmBtn.onclick = null;

      // 添加新的事件监听器
      confirmBtn.onclick = onConfirm;

      document.getElementById('confirmDialog').style.display = 'block';
    }

    // 隐藏确认对话框
    function hideConfirmDialog() {
      document.getElementById('confirmDialog').style.display = 'none';
    }
  </script>
</body>

</html>