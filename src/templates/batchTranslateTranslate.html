<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>批量翻译工具 - 批量翻译</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background-color: var(--vscode-editor-background);
      color: var(--vscode-editor-foreground);
      margin: 0;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    /* 标题样式 */
    h2 {
      color: var(--vscode-editor-foreground);
      border-bottom: 2px solid var(--vscode-focusBorder);
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .file-info {
      margin: 20px 0;
      padding: 15px;
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      line-height: 1.6;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin: 20px 0;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .check-results {
      background-color: var(--vscode-textBlockQuote-background);
      border-left: 4px solid var(--vscode-focusBorder);
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
    }

    .check-results h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      font-weight: bold;
    }

    .file-item {
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
    }

    .file-name {
      font-weight: bold;
      color: var(--vscode-textLink-foreground);
    }

    .missing-count {
      background-color: var(--vscode-notificationsErrorIcon-foreground);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    /* 翻译完成统计样式 */
    .translation-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-button {
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 12px;
      text-align: center;
    }

    .stat-button.success {
      border-color: var(--vscode-focusBorder);
    }

    .stat-button.translate {
      border-color: var(--vscode-notificationsInfoIcon-foreground);
    }

    .stat-button.failure {
      border-color: var(--vscode-notificationsErrorIcon-foreground);
    }

    .stat-label {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--vscode-textLink-foreground);
      margin-bottom: 4px;
    }

    .missing-details {
      margin-top: 10px;
      padding: 10px;
      background-color: var(--vscode-textBlockQuote-background);
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .missing-item {
      margin: 5px 0;
      padding: 5px;
      background-color: var(--vscode-editor-background);
      border-radius: 2px;
    }

    .progress-section {
      margin: 20px 0;
      padding: 15px;
      background: var(--vscode-editor-background);
      border-radius: 8px;
      border: 1px solid var(--vscode-panel-border);
      display: none;
    }

    .file-card {
      margin: 15px 0;
      background: var(--vscode-panel-background);
      border-radius: 8px;
      border: 1px solid var(--vscode-panel-border);
      overflow: hidden;
    }

    .file-card.translating {
      border-left: 4px solid var(--vscode-notificationsWarningIcon-foreground);
    }

    .file-card.completed {
      border-left: 4px solid #28a745;
    }

    .file-card.failed {
      border-left: 4px solid var(--vscode-errorForeground);
    }

    .file-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--vscode-editor-background);
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .progress-item {
      margin: 8px 0;
      padding: 0 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .progress-item .translation-content {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .progress-item .key-name {
      color: var(--vscode-textLink-foreground);
      font-weight: 500;
    }

    .progress-item .line-number {
      color: var(--vscode-descriptionForeground);
      font-size: 12px;
    }

    .translator-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
      margin-right: 8px;
    }

    .progress-status {
      font-weight: bold;
    }

    .progress-status.success {
      color: var(--vscode-notificationsInfoIcon-foreground);
    }

    .progress-status.error {
      color: var(--vscode-notificationsErrorIcon-foreground);
    }

    .progress-details {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .result-section {
      margin: 20px 0;
      padding: 15px;
      background-color: var(--vscode-textBlockQuote-background);
      border-radius: 4px;
      display: none;
    }

    /* 删除不需要的详细结果样式 */

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--vscode-descriptionForeground);
    }

    .error {
      background-color: var(--vscode-inputValidation-errorBackground);
      color: var(--vscode-inputValidation-errorForeground);
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>批量翻译工具 - 批量翻译</h2>

    <div id="fileInfo" class="file-info" style="display: none;">
      <strong>源文件: </strong><span id="sourceFileName"></span>，
      <strong>目标文件: </strong><span id="targetFileNames"></span>
    </div>

    <div class="action-buttons">
      <button id="previewBtn" onclick="previewPlan()">预览计划</button>
      <button id="translateBtn" onclick="startTranslate()" disabled>开始翻译</button>
    </div>

    <div id="checkResults" class="check-results" style="display: none;">
      <h3>预览结果</h3>
      <div id="checkResultsList"></div>
    </div>

    <div id="progressSection" class="progress-section">
      <h3>翻译进度</h3>
      <div id="progressList"></div>
    </div>

    <div id="resultSection" class="result-section">
      <h3>翻译完成统计</h3>
      <div id="translationStats" class="translation-stats">
        <div class="stat-button success">
          <span class="stat-label">成功:</span>
          <span class="stat-value" id="successCount">0/0 个文件</span>
        </div>
        <div class="stat-button translate">
          <span class="stat-label">翻译:</span>
          <span class="stat-value" id="translatedCount">0 个错误码</span>
        </div>
        <div class="stat-button failure">
          <span class="stat-label">失败:</span>
          <span class="stat-value" id="failureCount">0 个</span>
        </div>
      </div>
      <!-- 删除详细结果列表，只保留精简统计 -->
    </div>

    <div id="loadingSection" class="loading" style="display: none;">正在分析文件结构，请稍候...</div>
    <div id="errorSection" class="error" style="display: none;"></div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();

    // 页面加载完成后自动获取文件信息
    document.addEventListener('DOMContentLoaded', () => {
      vscode.postMessage({ command: 'getSourceFiles' });
    });

    // 预览翻译计划
    function previewPlan() {
      showLoading();
      vscode.postMessage({ command: 'previewPlan' });
    }

    // 开始批量翻译
    function startTranslate() {
      showProgress();
      vscode.postMessage({ command: 'startTranslate' });
    }

    // 显示加载状态
    function showLoading() {
      document.getElementById('loadingSection').style.display = 'block';
      document.getElementById('checkResults').style.display = 'none';
      document.getElementById('progressSection').style.display = 'none';
      document.getElementById('resultSection').style.display = 'none';
      document.getElementById('errorSection').style.display = 'none';
    }

    // 隐藏加载状态
    function hideLoading() {
      document.getElementById('loadingSection').style.display = 'none';
    }

    // 显示进度
    function showProgress() {
      document.getElementById('progressSection').style.display = 'block';
      document.getElementById('checkResults').style.display = 'none';
      document.getElementById('resultSection').style.display = 'none';
      document.getElementById('errorSection').style.display = 'none';
    }

    // 显示错误
    function showError(message) {
      const errorSection = document.getElementById('errorSection');
      errorSection.textContent = message;
      errorSection.style.display = 'block';
      hideLoading();
    }

    // 隐藏错误
    function hideError() {
      document.getElementById('errorSection').style.display = 'none';
    }

    // 监听来自扩展的消息
    window.addEventListener('message', event => {
      const message = event.data;

      switch (message.command) {
        case 'fileInfoResult':
          if (message.success) {
            displayFileInfo(message.sourceFile, message.files);
          } else {
            showError(message.message);
          }
          break;

        case 'previewResult':
          if (message.success) {
            displayPreviewResults(message.results);
            document.getElementById('translateBtn').disabled = false;
          } else {
            showError(message.message);
          }
          hideLoading();
          break;

        case 'translateProgress':
          handleTranslateProgress(message);
          break;

        case 'translateResult':
          if (message.success) {
            updateTranslationStats(message.results);
            displayTranslateResults(message.results);
          } else {
            showError(message.message);
          }
          break;
      }
    });

    // 显示文件信息
    function displayFileInfo(sourceFile, files) {
      document.getElementById('sourceFileName').textContent = sourceFile;
      document.getElementById('targetFileNames').textContent = files.map(f => f.name).join(', ');
      document.getElementById('fileInfo').style.display = 'block';
    }

    // 显示预览结果
    function displayPreviewResults(results) {
      const container = document.getElementById('checkResultsList');
      let html = '';

      results.forEach(result => {
        html += `
          <div class="file-item">
            <div class="file-header">
              <span class="file-name">${result.file}</span>
              <span class="missing-count">${result.missingCount} 个缺失</span>
            </div>
            ${result.missingCount > 0 ? `
              <div class="missing-details">
                ${result.missingTranslations.map(item => `
                  <div class="missing-item">
                    <strong>${item.key}:</strong> "${item.value}" (第${item.lineNumber}行)
                  </div>
                `).join('')}
              </div>
            ` : '<div style="color: var(--vscode-descriptionForeground);">无需翻译</div>'}
          </div>
        `;
      });

      container.innerHTML = html;
      document.getElementById('checkResults').style.display = 'block';
    }

    // 获取翻译工具文字标识
    function getTranslatorText(translator) {
      if (translator === 'google') {
        return 'G';
      } else if (translator === 'mymemory') {
        return 'M';
      } else {
        return '?';
      }
    }

    // 处理翻译进度
    function handleTranslateProgress(message) {
      const container = document.getElementById('progressList');
      let fileCard = container.querySelector(`[data-file="${message.file}"]`);

      if (!fileCard) {
        // 创建新的文件卡片
        fileCard = document.createElement('div');
        fileCard.className = 'file-card';
        fileCard.setAttribute('data-file', message.file);
        fileCard.style.borderLeft = '4px solid var(--vscode-notificationsWarningIcon-foreground)';
        container.appendChild(fileCard);
      }

      switch (message.type) {
        case 'start':
          // 开始翻译新文件
          fileCard.innerHTML = `
            <div class="file-header">
              <span class="file-name">${message.file}</span>
              <span class="progress-status">翻译中...</span>
            </div>
            <div class="file-content"></div>
          `;
          break;

        case 'success':
          // 翻译成功，添加到文件内容中
          const fileContent = fileCard.querySelector('.file-content');
          if (fileContent) {
            const successItem = document.createElement('div');
            successItem.className = 'progress-item';
            successItem.innerHTML = `
              <div class="translation-content">
                <span class="translator-icon">${getTranslatorText(message.translator || 'default')}</span>
                <span class="key-name">${message.code}:</span>
                <span class="progress-details">${message.translatedValue}</span>
              </div>
              <span class="line-number">(第${message.lineNumber}行)</span>
            `;
            fileContent.appendChild(successItem);
          }
          break;

        case 'error':
          // 翻译失败，添加到文件内容中
          const errorContent = fileCard.querySelector('.file-content');
          if (errorContent) {
            const errorItem = document.createElement('div');
            errorItem.className = 'progress-item';
            errorItem.innerHTML = `
              <div class="translation-content">
                <span class="progress-status error">❌</span>
                <span class="key-name">${message.key}:</span>
                <span class="progress-details">翻译失败: ${message.error}</span>
              </div>
              <span class="line-number">(第${message.lineNumber}行)</span>
            `;
            errorContent.appendChild(errorItem);
          }
          break;

        case 'fileComplete':
          // 文件完成
          const header = fileCard.querySelector('.file-header');
          if (header) {
            if (message.success) {
              header.innerHTML = `
                <span class="file-name">${message.file}</span>
                <span class="progress-status success">完成 ${message.translated} 项</span>
              `;
              fileCard.style.borderLeft = '4px solid #28a745';
            } else {
              header.innerHTML = `
                <span class="file-name">${message.file}</span>
                <span class="progress-status error">翻译失败</span>
              `;
              fileCard.style.borderLeft = '4px solid var(--vscode-errorForeground)';
            }
          }
          break;
      }
    }

    // 隐藏进度
    function hideProgress() {
      document.getElementById('progressSection').style.display = 'none';
    }

    // 更新翻译统计信息
    function updateTranslationStats(results) {
      const totalFiles = results.length;
      const successFiles = results.filter(r => r.success).length;
      const failureFiles = results.filter(r => !r.success).length;
      const totalTranslated = results.reduce((sum, r) => sum + (r.translated || 0), 0);

      document.getElementById('successCount').textContent = `${successFiles}/${totalFiles} 个文件`;
      document.getElementById('translatedCount').textContent = `${totalTranslated} 个错误码`;
      document.getElementById('failureCount').textContent = `${failureFiles} 个`;
    }

    // 显示翻译结果（只显示统计信息，不显示详细列表）
    function displayTranslateResults(results) {
      // 只显示统计区域，不显示详细结果列表
      document.getElementById('resultSection').style.display = 'block';
    }
  </script>
</body>

</html>