<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹é‡å¤šè¯­è¨€ç¿»è¯‘</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background-color: var(--vscode-editor-background);
      color: var(--vscode-editor-foreground);
      margin: 0;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      color: var(--vscode-editor-foreground);
      border-bottom: 2px solid var(--vscode-focusBorder);
      padding-bottom: 10px;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: bold;
    }

    .description {
      background-color: var(--vscode-textBlockQuote-background);
      border-left: 4px solid var(--vscode-focusBorder);
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    .description h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      font-weight: bold;
    }

    .description ul {
      margin: 0;
      padding-left: 20px;
    }

    .description li {
      margin: 5px 0;
      line-height: 1.5;
    }

    .file-info {
      margin: 20px 0;
      padding: 15px;
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      line-height: 1.6;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin: 20px 0;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .check-results {
      background-color: var(--vscode-textBlockQuote-background);
      border-left: 4px solid var(--vscode-focusBorder);
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
    }

    .check-results h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      font-weight: bold;
    }

    .check-results ul {
      margin: 0;
      padding-left: 20px;
    }

    .check-results li {
      margin: 8px 0;
      line-height: 1.5;
    }

    .check-results .no-translation {
      color: var(--vscode-notificationsInfoIcon-foreground);
      font-weight: 500;
    }

    .check-results .need-translation {
      color: var(--vscode-notificationsWarningIcon-foreground);
      font-weight: 500;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--vscode-descriptionForeground);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--vscode-panel-border);
      border-radius: 50%;
      border-top-color: var(--vscode-focusBorder);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .success {
      color: var(--vscode-notificationsInfoIcon-foreground);
    }

    .warning {
      color: var(--vscode-notificationsWarningIcon-foreground);
    }

    .error-result {
      color: var(--vscode-errorForeground);
    }

    .translate-results {
      margin-top: 20px;
      padding: 15px;
      background: var(--vscode-editor-background);
      border-radius: 8px;
      border: 1px solid var(--vscode-panel-border);
    }

    .file-content {
      padding: 8px;
    }

    .translate-item {
      display: flex;
      align-items: center;
      padding: 0 16px;
      margin-bottom: 8px;
    }

    .translate-item:last-child {
      margin-bottom: 0;
    }

    .translate-item .status {
      margin-right: 8px;
      font-size: 16px;
    }

    .translate-item .status.translating {
      color: var(--vscode-notificationsWarningIcon-foreground);
    }

    .translate-item .status.success {
      color: var(--vscode-notificationsInfoIcon-foreground);
    }

    .translate-item .status.error {
      color: var(--vscode-errorForeground);
    }

    .translate-item .code {
      font-weight: bold;
      margin-right: 8px;
      color: var(--vscode-focusBorder);
    }

    .translate-item .message {
      flex: 1;
      margin-right: 8px;
    }

    .translate-item .line {
      color: var(--vscode-descriptionForeground);
      font-size: 12px;
    }

    .file-card {
      margin: 15px 0;
      background: var(--vscode-panel-background);
      border-radius: 8px;
      border: 1px solid var(--vscode-panel-border);
      overflow: hidden;
    }

    .file-card.translating {
      border-left: 4px solid var(--vscode-notificationsWarningIcon-foreground);
    }

    .file-card.completed {
      border-left: 4px solid #28a745;
    }

    .file-card.failed {
      border-left: 4px solid var(--vscode-errorForeground);
    }

    .file-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: var(--vscode-editor-background);
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .file-header .status {
      margin-right: 8px;
      font-size: 16px;
    }

    .file-header .file-title {
      font-weight: bold;
      color: var(--vscode-foreground);
    }

    .translate-summary {
      margin-top: 20px;
      padding: 15px;
      background: var(--vscode-panel-background);
      border-radius: 8px;
      border: 1px solid var(--vscode-panel-border);
    }

    .translate-summary h4 {
      margin: 0 0 15px 0;
      color: var(--vscode-focusBorder);
    }

    .summary-stats {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .stat-item {
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      background: var(--vscode-editor-background);
      border: 1px solid;
    }

    .stat-item.total {
      color: var(--vscode-focusBorder);
      border-color: var(--vscode-focusBorder);
    }

    .stat-item.success {
      color: #28a745;
      border-color: #28a745;
    }

    .stat-item.error {
      color: var(--vscode-errorForeground);
      border-color: var(--vscode-errorForeground);
    }

    .section-header {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .close-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: none;
      border: none;
      color: var(--vscode-descriptionForeground);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      font-size: 16px;
      line-height: 1;
    }

    .close-btn:hover {
      background: var(--vscode-toolbar-hoverBackground);
      color: var(--vscode-foreground);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>æ‰¹é‡å¤šè¯­è¨€ç¿»è¯‘</h1>

    <div class="description">
      <h3>åŠŸèƒ½è¯´æ˜:</h3>
      <ul>
        <li>è‡ªåŠ¨æ ¹æ®"æ–‡ä»¶é…ç½®"æ‰¹é‡ç¿»è¯‘æ‰€æœ‰ç›®æ ‡è¯­è¨€æ–‡ä»¶</li>
        <li>æ— éœ€æ‰‹åŠ¨é€‰æ‹©,ç›´æ¥ç‚¹å‡»æŒ‰é’®å³å¯</li>
        <li>æ”¯æŒé¢„è§ˆç¿»è¯‘è®¡åˆ’å’Œä¸€é”®æ‰¹é‡ç¿»è¯‘</li>
      </ul>
    </div>

    <div class="file-info" id="fileInfo">
      <div class="loading">
        <div class="spinner"></div>
        æ­£åœ¨åŠ è½½æ–‡ä»¶ä¿¡æ¯...
      </div>
    </div>

    <div class="action-buttons">
      <button id="previewBtn" onclick="previewPlan()">é¢„è§ˆè®¡åˆ’</button>
      <button id="translateBtn" onclick="startTranslate()">å¼€å§‹ç¿»è¯‘</button>
    </div>

    <div class="check-results" id="checkResults" style="display: none;">
      <div class="section-header">
        <h3 id="checkTitle">å°†ä» zh-CN.js æ£€æŸ¥åˆ°:</h3>
        <button class="close-btn" onclick="closeCheckResults()" title="å…³é—­">Ã—</button>
      </div>
      <ul id="checkList">
      </ul>
    </div>

    <div class="translate-results" id="translateResults" style="display: none;">
      <div class="section-header">
        <h3>ç¿»è¯‘è¿›åº¦:</h3>
        <button class="close-btn" onclick="closeTranslateResults()" title="å…³é—­">Ã—</button>
      </div>
      <div id="translateProgress">
        <div class="loading">
          <div class="spinner"></div>
          æ­£åœ¨ç¿»è¯‘ä¸­...
        </div>
      </div>
    </div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();

    // é¡µé¢åŠ è½½æ—¶è·å–æ–‡ä»¶ä¿¡æ¯
    window.addEventListener('load', () => {
      loadFileInfo();
    });

    // åŠ è½½æ–‡ä»¶ä¿¡æ¯
    function loadFileInfo() {
      vscode.postMessage({ command: 'getSourceFiles' });
    }

    // é¢„è§ˆè®¡åˆ’
    function previewPlan() {
      const checkResults = document.getElementById('checkResults');
      const checkList = document.getElementById('checkList');

      checkList.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨æ£€æŸ¥ç¿»è¯‘è®¡åˆ’...</div>';
      checkResults.style.display = 'block';

      vscode.postMessage({ command: 'previewPlan' });
    }

    // å¼€å§‹ç¿»è¯‘
    function startTranslate() {
      const translateBtn = document.getElementById('translateBtn');
      translateBtn.textContent = 'ç¿»è¯‘ä¸­...';
      translateBtn.disabled = true;

      // æ˜¾ç¤ºç¿»è¯‘è¿›åº¦åŒºåŸŸ
      const translateResults = document.getElementById('translateResults');
      const translateProgress = document.getElementById('translateProgress');
      translateProgress.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨ç¿»è¯‘ä¸­...</div>';
      translateResults.style.display = 'block';

      vscode.postMessage({ command: 'startTranslate' });
    }

    // å…³é—­é¢„è§ˆè®¡åˆ’
    function closeCheckResults() {
      const checkResults = document.getElementById('checkResults');
      checkResults.style.display = 'none';
    }

    // å…³é—­ç¿»è¯‘è¿›åº¦
    function closeTranslateResults() {
      const translateResults = document.getElementById('translateResults');
      translateResults.style.display = 'none';
    }

    // ç›‘å¬æ‰©å±•æ¶ˆæ¯
    window.addEventListener('message', event => {
      const message = event.data;

      switch (message.command) {
        case 'fileInfoResult':
          handleFileInfoResult(message);
          break;
        case 'previewResult':
          handlePreviewResult(message);
          break;
        case 'translateProgress':
          handleTranslateProgress(message);
          break;
        case 'translateResult':
          handleTranslateResult(message);
          break;
      }
    });

    // å¤„ç†æ–‡ä»¶ä¿¡æ¯ç»“æœ
    function handleFileInfoResult(message) {
      const fileInfo = document.getElementById('fileInfo');
      const checkTitle = document.getElementById('checkTitle');

      if (!message.success) {
        fileInfo.innerHTML = `<div class="error-result">âŒ ${message.message}</div>`;
        return;
      }

      const sourceFile = message.sourceFile || 'zh-CN.js';
      const targetFiles = message.files || [];
      const targetFileNames = targetFiles.map(f => f.name).join(', ');

      fileInfo.innerHTML = `æºæ–‡ä»¶: ${sourceFile}, ç›®æ ‡è¯­è¨€æ–‡ä»¶: ${targetFileNames}`;
      checkTitle.innerHTML = `å°†ä» ${sourceFile} æ£€æŸ¥åˆ°:`;
    }

    // å¤„ç†é¢„è§ˆç»“æœ
    function handlePreviewResult(message) {
      const checkList = document.getElementById('checkList');

      if (!message.success) {
        checkList.innerHTML = `<div class="error-result">âŒ ${message.message}</div>`;
        return;
      }

      let html = '';
      message.results.forEach(result => {
        if (result.missingCount === 0) {
          html += `<li class="no-translation">${result.file} ï¼ˆç¼ºå¤± 0 é¡¹ï¼‰</li>`;
        } else {
          html += `<li class="need-translation">${result.file} ï¼ˆç¼ºå¤± ${result.missingCount} é¡¹ï¼‰`;

          // å¦‚æœæœ‰ç¼ºå¤±çš„é”™è¯¯ç ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
          if (result.missingCodes && result.missingCodes.length > 0) {
            html += '<ul>';
            result.missingCodes.forEach(missingCode => {
              const lineText = missingCode.lineNumber > 0 ? `ï¼ˆç¬¬${missingCode.lineNumber}è¡Œï¼‰` : '';
              html += `<li>${missingCode.code}: ${missingCode.message}${lineText}</li>`;
            });
            html += '</ul>';
          }

          html += '</li>';
        }
      });

      checkList.innerHTML = html;
    }

    // å¤„ç†ç¿»è¯‘è¿›åº¦
    function handleTranslateProgress(message) {
      const translateProgress = document.getElementById('translateProgress');

      if (message.type === 'start') {
        // å¼€å§‹ç¿»è¯‘æ–°æ–‡ä»¶æ—¶ï¼Œåˆ›å»ºæ–°çš„æ–‡ä»¶å¡ç‰‡
        const fileCardHtml = `
          <div class="file-card translating" data-file="${message.file}">
            <div class="file-header">
              <span class="status translating">ğŸ”„</span>
              <span class="file-title">æ­£åœ¨ç¿»è¯‘ ${message.file}ï¼š</span>
            </div>
            <div class="file-content">
            </div>
          </div>
        `;
        translateProgress.innerHTML += fileCardHtml;
      } else if (message.type === 'success') {
        // åœ¨å¯¹åº”æ–‡ä»¶çš„å¡ç‰‡ä¸­æ·»åŠ ç¿»è¯‘ç»“æœ
        const fileCard = translateProgress.querySelector(`[data-file="${message.file}"]`);
        if (fileCard) {
          const fileContent = fileCard.querySelector('.file-content');
          if (fileContent) {
            const progressHtml = `
              <div class="translate-item">
                <span class="status success">âœ…</span>
                <span class="code">${message.code}</span>
                <span class="message">${message.translatedMessage}</span>
                <span class="line">(ç¬¬${message.lineNumber}è¡Œ)</span>
              </div>
            `;
            fileContent.innerHTML += progressHtml;
          }
        }
      } else if (message.type === 'error') {
        // åœ¨å¯¹åº”æ–‡ä»¶çš„å¡ç‰‡ä¸­æ·»åŠ é”™è¯¯ä¿¡æ¯
        const fileCard = translateProgress.querySelector(`[data-file="${message.file}"]`);
        if (fileCard) {
          const fileContent = fileCard.querySelector('.file-content');
          if (fileContent) {
            const progressHtml = `
              <div class="translate-item">
                <span class="status error">âŒ</span>
                <span class="code">${message.code}</span>
                <span class="message">ç¿»è¯‘å¤±è´¥: ${message.error}</span>
                <span class="line">(ç¬¬${message.lineNumber}è¡Œ)</span>
              </div>
            `;
            fileContent.innerHTML += progressHtml;
          }
        }
      } else if (message.type === 'fileComplete') {
        // æ–‡ä»¶å®Œæˆæ—¶ï¼Œæ›´æ–°æ–‡ä»¶å¡ç‰‡çŠ¶æ€
        const fileCard = translateProgress.querySelector(`[data-file="${message.file}"]`);
        if (fileCard) {
          const fileHeader = fileCard.querySelector('.file-header');

          if (message.success) {
            const completedText = message.translated > 0 ? `ï¼ˆå®Œæˆ ${message.translated} é¡¹ï¼‰ï¼š` : 'ï¼ˆç¼ºå¤± 0 é¡¹ï¼‰';
            fileHeader.innerHTML = `
              <span class="status success">âœ…</span>
              <span class="file-title">${message.file}${completedText}</span>
            `;
            fileCard.className = 'file-card completed';

            if (message.translated === 0) {
              const fileContent = fileCard.querySelector('.file-content');
              if (fileContent) {
                fileContent.remove();
              }
            }
          } else {
            fileHeader.innerHTML = `
              <span class="status error">âŒ</span>
              <span class="file-title">${message.file}ï¼ˆç¿»è¯‘å¤±è´¥ï¼‰ï¼š</span>
            `;
            fileCard.className = 'file-card failed';
          }
        }
      }
    }

    // å¤„ç†ç¿»è¯‘ç»“æœ
    function handleTranslateResult(message) {
      const translateBtn = document.getElementById('translateBtn');
      translateBtn.textContent = 'å¼€å§‹ç¿»è¯‘';
      translateBtn.disabled = false;

      if (!message.success) {
        const translateProgress = document.getElementById('translateProgress');
        translateProgress.innerHTML += `<div class="error-result">âŒ ç¿»è¯‘å¤±è´¥: ${message.message}</div>`;
        return;
      }

      // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
      const results = message.results;
      const totalFiles = results.length;
      const successFiles = results.filter(r => r.success).length;
      const totalTranslated = results.reduce((sum, r) => sum + (r.translated || 0), 0);
      const totalErrors = results.reduce((sum, r) => sum + (r.errors?.length || 0), 0);

      const translateProgress = document.getElementById('translateProgress');

      // ç§»é™¤"æ­£åœ¨ç¿»è¯‘ä¸­..."çš„åŠ è½½çŠ¶æ€
      const loadingElements = translateProgress.querySelectorAll('.loading');
      loadingElements.forEach(element => element.remove());

      const summaryHtml = `
        <div class="translate-summary">
          <h4>ğŸ“Š ç¿»è¯‘å®Œæˆç»Ÿè®¡</h4>
          <div class="summary-stats">
            <span class="stat-item total">æˆåŠŸ: ${successFiles}/${totalFiles} ä¸ªæ–‡ä»¶</span>
            <span class="stat-item success">ç¿»è¯‘: ${totalTranslated} ä¸ªé”™è¯¯ç </span>
            <span class="stat-item error">å¤±è´¥: ${totalErrors} ä¸ª</span>
          </div>
        </div>
      `;
      translateProgress.innerHTML += summaryHtml;
    }
  </script>
</body>

</html>